<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Morapack WS Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 20px; }
    #log { white-space: pre-wrap; border: 1px solid #ddd; padding: 8px; height: 300px; overflow: auto; }
  </style>
</head>
<body>
  <h2>Morapack WebSocket Demo</h2>
  <div>
    <button id="connectBtn">Connect</button>
    <button id="startBtn" disabled>Start Simulation</button>
    <button id="stopBtn" disabled>Stop Simulation</button>
  </div>
  <h3>Messages</h3>
  <div id="log"></div>

  <script>
    let stompClient = null;
    const logEl = document.getElementById('log');
    function log(msg) { logEl.textContent += msg + '\n'; logEl.scrollTop = logEl.scrollHeight; }

    document.getElementById('connectBtn').addEventListener('click', () => {
      if (stompClient && stompClient.connected) { log('Already connected'); return; }
      const socket = new SockJS('/ws');
      stompClient = Stomp.over(socket);
      stompClient.debug = function(){}; // silence verbose logs
      stompClient.connect({}, () => {
        log('Connected to /ws');
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = false;
        stompClient.subscribe('/topic/simulation', (message) => {
          try {
            const body = JSON.parse(message.body);
            log('[RECV] ' + JSON.stringify(body));
          } catch (e) {
            // maybe it's already JSON object
            log('[RECV] ' + message.body);
          }
        });
      }, (err) => { log('ERROR: ' + err); });
    });

    document.getElementById('startBtn').addEventListener('click', () => {
      if (!stompClient || !stompClient.connected) { log('Not connected'); return; }
      const payload = JSON.stringify({ initialTime: { year: 2025, month: 5, day: 8, hour: 8, minute: 0 } });
      stompClient.send('/app/init', {}, payload);
      log('Sent /app/init');
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
      if (!stompClient || !stompClient.connected) { log('Not connected'); return; }
      stompClient.send('/app/stop', {}, {});
      log('Sent /app/stop');
    });
  </script>
</body>
</html>
